name: Daily ICC (5pm US/Eastern, Mon–Fri)

on:
  workflow_dispatch: {}
  schedule:
    # 5:00pm ET in DST (UTC-4)
    - cron: "00 21 * * 1-5"
    # 5:00pm ET in Standard Time (UTC-5)
    - cron: "00 22 * * 1-5"

permissions:
  contents: write

concurrency:
  group: daily-icc
  cancel-in-progress: false  # don't let the second cron cancel a running job

jobs:
  gate:
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - name: Decide whether to run (any time during 5pm America/New_York)
        id: check
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            NY_HOUR=$(TZ=America/New_York date +%H)
            NY_MIN=$(TZ=America/New_York date +%M)
            # Allow the full 5pm hour (17:00–17:59 ET) to tolerate scheduler jitter
            if [ "$NY_HOUR" -eq 17 ]; then
              echo "proceed=true" >> "$GITHUB_OUTPUT"
              echo "Proceeding: NY time is ${NY_HOUR}:${NY_MIN} (within 5pm hour)."
            else
              echo "proceed=false" >> "$GITHUB_OUTPUT"
              echo "Skipping: NY time is ${NY_HOUR}:${NY_MIN} (outside 5pm hour)."
            fi
          else
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            echo "Manual dispatch → proceed."
          fi

  run-icc:
    needs: gate
    if: needs.gate.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Mark workspace as safe
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pandas numpy yfinance lxml html5lib requests tzdata python-dateutil
          fi

      - name: Run daily ICC (writes into data/YYYYMM/)
        env:
          IGNORE_TIME_GUARD: "0"
        run: python run_daily_icc.py

      - name: Generate FILES.md manifest (show all files)
        run: python tools/generate_files_manifest.py

      - name: Print repository file list to logs
        run: find . -type f | sort

      - name: Commit & push (rebase-safe, idempotent)
        shell: bash
        env:
          BRANCH_NAME: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          BRANCH="${BRANCH_NAME:-main}"

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 0) Fetch for remote checks (safe; does not touch worktree)
          git fetch origin "${BRANCH}"

          # 1) If today's update already on remote, skip entirely
          ts=$(date -u +"%Y-%m-%d")
          if git log -n 50 --pretty=%s origin/"${BRANCH}" | grep -Fq "Daily ICC update ${ts}"; then
            echo "Already updated today on remote. Skipping commit."
            exit 0
          fi

          # 2) Stage & commit local changes FIRST (avoid rebase with dirty worktree)
          git add -A data FILES.md || true
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Daily ICC update ${ts} [skip ci]"

          # 3) Rebase on remote and push (autostash for safety)
          git pull --rebase --autostash origin "${BRANCH}" || true
          git push origin HEAD:"${BRANCH}" || {
            echo "Push failed; re-pulling with rebase and retrying..."
            git pull --rebase --autostash origin "${BRANCH}"
            git push origin HEAD:"${BRANCH}"
          }
